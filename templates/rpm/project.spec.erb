%global debug_package %{nil}

Name:           <%= @name %>
Version:        <%= @version %>
Release:        1
Summary:        <%= @description.lines.first.chomp %>
Vendor:         <%= @vendor.match(/^(.*) <.*>$/)[1] %>
License:        <%= @license %>
Group:          System Environment/Base
URL:            <%= @homepage %>

BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

Source0:        %{name}-%{version}.tar.gz
Source1:        file-list-for-rpm

# Don't provide anything so the system doesn't use our packages to resolve deps
Autoprov: 0
Autoreq: 0
<%- get_requires.each do |requires| -%>
Requires:  <%= requires %>
<%- end -%>
<%- if has_services? -%>
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
BuildRequires:    systemd
%{?systemd_requires}
    <%- else -%>
BuildRequires:    systemd
Requires(post):   systemd
Requires(preun):  systemd
Requires(postun): systemd
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    <%- if @platform.is_sles? -%>
Requires: aaa_base
    <%- else -%>
Requires: chkconfig
    <%- end -%>
  <%- end -%>
<%- end -%>

%description
<%= @description %>

Contains the following components:
<%= @components.map {|comp| "#{comp.name} (#{comp.version})" }.sort.join("\n") %>

%prep
%setup -q -n %{name}-%{version}

%build

%clean

%install
rm -rf %{buildroot}
install -d %{buildroot}

# Copy each directory into place. Because empty directories won't make it into.
<%- get_directories.map {|d| d.path.sub(/^\//,'')}.each do |dir| -%>
  if [ -d <%= dir %> ]; then
    install -d %{buildroot}/<%= File.dirname(dir) %>
    cp -pr <%= dir %> %{buildroot}/<%= File.dirname(dir) %>
  else
    install -d %{buildroot}/<%= dir %>
  fi
<%- end -%>

# Copy each of the extra files into place
<%- get_files.map {|f| f.path.sub(/^\//,'')}.each do |file| -%>
  install -d %{buildroot}/<%= File.dirname(file) %>
  cp -p <%= file %> %{buildroot}/<%= File.dirname(file) %>
<%- end -%>

%pre
<%- if @user -%>
# Add our user and group
<%= @platform.add_group(@user) %>
<%= @platform.add_user(@user) %>
<%- end -%>

%post
<%- get_services.each do |service| -%>
  # switch based on systemd vs systemv
  #
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
      %service_add_post <%= service %>.service
    <%- else -%>
      %systemd_post <%= service %>.service
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    chkconfig --add <%= service %>
  <%- end -%>
<%- end -%>

%postun
<%- get_services.each do |service| -%>
  # switch based on systemd vs systemv
  #
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
      %service_del_postun <%= service %>.service
    <%- else -%>
      %systemd_postun_with_restart <%= service %>.service
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    if [ $1 -ge 1 ]; then
      /sbin/service <%= service %> condrestart
    fi
  <%- end -%>

<%- end -%>

%preun
<%- get_services.each do |service| -%>
  # switch based on systemd vs systemv
  #
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
      %service_del_preun <%= service %>.service
    <%- else -%>
      %systemd_preun <%= service %>.service
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    /sbin/service <%= service %> stop >/dev/null 2>&1
    chkconfig --del <%= service %>
  <%- end -%>
<%- end -%>


%files -f %{SOURCE1}
%defattr(-, root, root, 0755)
<%- get_directories.each do |dir| -%>
%dir %attr(<%= dir.mode || "-" %>, <%= dir.owner || "-" %>, <%= dir.group || "-" %>) <%= dir.path %>
<%- end -%>
<%- get_configfiles.each do |configfile| -%>
%config(noreplace) %attr(<%= configfile.mode || "-" %>, <%= configfile.owner || "-" %>, <%= configfile.group || "-" %>) <%= configfile.path %>
<%- end -%>
<%- (get_files - get_configfiles).each do |file| -%>
%attr(<%= file.mode || "-" %>, <%= file.owner || "-" %>, <%= file.group || "-" %>) <%= file.path %>
<%- end -%>

%changelog
* <%= Time.now.strftime("%a %b %d %Y") %> <%= @vendor %> -  <%= @version %>-1
- Build for <%= @version %>
