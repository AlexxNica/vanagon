%global debug_package %{nil}

# Turn off the brp-python-bytecompile script
%global __os_install_post %(echo '%{__os_install_post}' | sed -e 's!/usr/lib[^[:space:]]*/brp-python-bytecompile[[:space:]].*$!!g')
#

Name:           <%= @name %>
Version:        <%= @version %>
Release:        1%{?dist}
Summary:        <%= @description.lines.first.chomp %>
Vendor:         <%= @vendor.match(/^(.*) <.*>$/)[1] %>
License:        <%= @license %>
Group:          System Environment/Base
URL:            <%= @homepage %>

BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
<% if @noarch -%>
BuildArch:      noarch
<% end -%>

Source0:        %{name}-%{version}.tar.gz
Source1:        file-list-for-rpm

# Don't provide anything so the system doesn't use our packages to resolve deps
Autoprov: 0
Autoreq: 0
<%- get_requires.each do |requires| -%>
Requires:  <%= requires %>
<%- end -%>
<%- if has_services? -%>
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
BuildRequires:    systemd
%{?systemd_requires}
    <%- else -%>
BuildRequires:    systemd
Requires(post):   systemd
Requires(preun):  systemd
Requires(postun): systemd
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    <%- if @platform.is_sles? -%>
Requires: aaa_base
    <%- else -%>
Requires: chkconfig
    <%- end -%>
  <%- end -%>
<%- end -%>

<%- get_replaces.each do |replace| -%>
Conflicts: <%= replace.replacement %><%= replace.version ? " < #{replace.version}" : "" %>
Obsoletes: <%= replace.replacement %><%= replace.version ? " < #{replace.version}" : "" %>
<%- end -%>

<%- get_provides.each do |prov| -%>
Provides: <%= prov.provide %><%= prov.version ? " >= #{prov.version}" : "" %>
<%- end -%>

%description
<%= @description %>

Contains the following components:
<%= generate_bill_of_materials.join("\n") %>

%prep
%setup -q -n %{name}-%{version}

%build

%clean

%install
test -d /opt/freeware/bin && export PATH="/opt/freeware/bin:${PATH}"
rm -rf %{buildroot}
install -d %{buildroot}

# Copy each directory into place. Because empty directories won't make it into.
<%- get_directories.map {|d| d.path.sub(/^\//,'')}.each do |dir| -%>
  if [ -d <%= dir %> ]; then
    install -d %{buildroot}/<%= File.dirname(dir) %>
    cp -pr <%= dir %> %{buildroot}/<%= File.dirname(dir) %>
  else
    install -d %{buildroot}/<%= dir %>
  fi
<%- end -%>

# Copy each of the extra files into place
<%- get_files.map {|f| f.path.sub(/^\//,'')}.each do |file| -%>
  install -d %{buildroot}/<%= File.dirname(file) %>
  cp -p <%= file %> %{buildroot}/<%= File.dirname(file) %>
<%- end -%>

<%- if @platform.is_cisco_wrlinux? || @platform.is_huaweios? -%>
  # Generate a list of directories and append it to the file list. RPMv4
  # automatically does this implicitly, but RPMv5 is more strict and you
  # need to list the dirs for them to be packaged properly.
  <%- get_directories.map {|d| "%{buildroot}#{d.path}"}.each do |dir| -%>
    find <%= dir %> -type d | sed -e "s#%{buildroot}##" | sed -e 's/\(^.*\s.*$\)/"\1"/g' >> dir-list-rpm
  <%- end -%>
  cat dir-list-rpm | sort | uniq >> %{SOURCE1}
<%- end -%>

# Here we explicitly remove the directories and files that we list in the
# %files section separately because rpm3 on aix errors on duplicate files in
# the package.
<%- (get_directories + get_files + get_configfiles).map do |filething| -%>
  PATH=/opt/freeware/bin:$PATH sed -i 's|^<%= filething.path.include?(" ") ? %Q["#{filething.path}"] : filething.path %>$||g' %{SOURCE1}
<%- end -%>

%pre
<%- if @user -%>
# Add our user and group
<%= @platform.add_group(@user) %>
<%= @platform.add_user(@user) %>
<%- end -%>

%post
<%- get_services.each do |service| -%>
  # switch based on systemd vs systemv
  #
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
      %service_add_post <%= service.name %>.service
    <%- else -%>
      %systemd_post <%= service.name %>.service
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    <%- if @platform.is_sles? -%>
      chkconfig --add <%= service.name %> >/dev/null 2>&1 || :
    <%- else -%>
      chkconfig --add <%= service.name %>
    <%- end -%>
  <%- end -%>
<%- end -%>

%postun
<%- get_services.each do |service| -%>
  # switch based on systemd vs systemv
  #
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
      %service_del_postun <%= service.name %>.service
    <%- else -%>
      %systemd_postun_with_restart <%= service.name %>.service
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    if [ $1 -ge 1 ]; then
      /sbin/service <%= service.name %> condrestart
    fi
  <%- end -%>

<%- end -%>

%preun
<%- get_services.each do |service| -%>
  # switch based on systemd vs systemv
  #
  <%- if @platform.servicetype == "systemd" -%>
    <%- if @platform.is_sles? -%>
      %service_del_preun <%= service.name %>.service
    <%- else -%>
      %systemd_preun <%= service.name %>.service
    <%- end -%>
  <%- elsif @platform.servicetype == "sysv" -%>
    /sbin/service <%= service.name %> stop >/dev/null 2>&1
    chkconfig --del <%= service.name %>
  <%- end -%>
<%- end -%>


%files -f %{SOURCE1}
%doc bill-of-materials
%defattr(-, root, root, 0755)
<%- get_directories.each do |dir| -%>
%dir %attr(<%= dir.mode || "-" %>, <%= dir.owner || "-" %>, <%= dir.group || "-" %>) <%= dir.path %>
<%- end -%>
<%- get_configfiles.each do |configfile| -%>
%config(noreplace) %attr(<%= configfile.mode || "-" %>, <%= configfile.owner || "-" %>, <%= configfile.group || "-" %>) <%= configfile.path %>
<%- end -%>
<%- (get_files - get_configfiles).each do |file| -%>
%attr(<%= file.mode || "-" %>, <%= file.owner || "-" %>, <%= file.group || "-" %>) <%= file.path %>
<%- end -%>

%changelog
* <%= Time.now.strftime("%a %b %d %Y") %> <%= @vendor %> -  <%= @version %>-1
- Build for <%= @version %>
