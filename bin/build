#!/usr/bin/env ruby

def usage
  puts <<-EOS
  #{File.basename(__FILE__)} <project-name> <platform-name> [options]
  Options:
    target - where to build the project (defaults to grabbing one from the pooler)
    preserve - whether to tear down the vm on success or not (defaults to false)
EOS
end

FLAG_REGEX = /^(-|--).*$/
flags = ARGV.select {|arg| arg.match(FLAG_REGEX) }
args = ARGV.reject {|arg| arg.match(FLAG_REGEX) }

project = args[0]
platform = args[1]
target = args[2]
preserve = flags.include?("--preserve")
verbose = flags.include?("-v")
configdir = File.join(Dir.pwd, "configs")

if project.nil? or platform.nil?
  STDERR.puts "project and platform are both required arguments."
  usage
  exit 1
end

load File.expand_path(File.join(File.dirname(__FILE__), "..", "lib", "vanagon.rb"))
artifact = Vanagon.new(platform, project, configdir)
artifact.run(target, preserve, verbose)
